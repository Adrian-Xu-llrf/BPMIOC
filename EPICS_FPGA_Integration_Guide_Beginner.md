# EPICS IOC 与 FPGA 交互 - 初学者理解指南

**适合人群**: 无编程基础，想理解系统原理

---

## 1. 核心概念：系统是如何工作的？

### 1.1 简单类比

想象一个自动售货机：

```
用户（你）        售货机界面      控制系统        机械部分
   │                │              │              │
   ├─ 按下按钮 ────►│              │              │
   │                ├─ 接收指令 ──►│              │
   │                │              ├─ 控制电机 ──►│
   │                │              │◄─ 读取状态 ──┤
   │                │◄─ 显示状态 ──┤              │
   │◄─ 拿到饮料 ────┤              │              │
```

**EPICS-FPGA 系统的对应关系**：

```
操作员           EPICS PV       IOC软件        FPGA硬件
   │                │              │              │
   ├─ caget ───────►│              │              │
   │                ├─ Record ────►│              │
   │                │              ├─ 读寄存器 ──►│
   │                │              │◄─ 返回数据 ──┤
   │                │◄─ 显示值 ────┤              │
   │◄─ 看到结果 ────┤              │              │
```

### 1.2 三个关键问题

**Q1: 什么是 PV（Process Variable）？**

PV 就是一个"有名字的数据"，类似于：
- 温度传感器 → `Room:Temperature`
- 开关状态 → `Light:Status`
- BPM 幅度 → `BPM:CH0:Amp`

你可以用命令读写这些 PV：
```bash
$ caget BPM:CH0:Amp
BPM:CH0:Amp    0.12345    # 读取到的值

$ caput Light:Status 1
Light:Status   1          # 打开灯
```

**Q2: 什么是 FPGA？**

FPGA 是一个可编程的硬件芯片，就像一个"超级计算器"：
- 可以非常快速地处理数据（纳秒级）
- 可以同时做很多事情（并行处理）
- 通过寄存器与外界交互

**Q3: IOC 是什么？**

IOC（Input/Output Controller）是运行在计算机上的软件，负责：
- 连接 PV 和 FPGA
- 翻译数据（把 FPGA 的数字转成有意义的值）
- 提供网络访问（让远程用户能看到 PV）

---

## 2. 数据如何流动？（重点理解）

### 2.1 读取流程（获取数据）

```
第1步：用户发出请求
    $ caget BPM:CH0:Amp
         │
         ▼
第2步：找到对应的 Record（数据库记录）
    record(ai, "BPM:CH0:Amp") {
        field(INP, "@AMP:0 ch=0")  # 说明：幅度，通道0
    }
         │
         ▼
第3步：Device Support 解析参数
    "@AMP:0 ch=0"
    → type=AMP, offset=0, channel=0
         │
         ▼
第4步：Driver Support 读取 FPGA
    读取地址 0x0010（基地址 + offset）
    获得原始数据：0x00012345
         │
         ▼
第5步：数据转换
    原始值 0x00012345 → 除以 1.28e6 → 0.00896伏特
         │
         ▼
第6步：返回给用户
    BPM:CH0:Amp    0.00896
```

**关键点**：
- 你只需要知道 PV 的名字
- 所有复杂的转换都由 IOC 自动完成
- FPGA 只是存储原始数字

### 2.2 写入流程（控制硬件）

```
第1步：用户发出命令
    $ caput BPM:K1:Set 1.234
         │
         ▼
第2步：数据转换
    1.234 → 乘以 32767 → 0x00009EBA（FPGA能理解的格式）
         │
         ▼
第3步：写入 FPGA 寄存器
    地址 0x0300 ← 写入 0x00009EBA
         │
         ▼
第4步：FPGA 应用新参数
    使用新的 K1 系数计算位置
```

---

## 3. 谁负责什么？（职责划分）

### 3.1 FPGA 团队负责

```
┌─────────────────────────────────────┐
│        FPGA 团队的工作              │
├─────────────────────────────────────┤
│ ✅ 设计 FPGA 内部逻辑               │
│    （数据采集、信号处理等）         │
│                                     │
│ ✅ 提供寄存器接口                   │
│    地址：0x0010 = 通道0幅度        │
│    地址：0x0100 = 数字输出         │
│                                     │
│ ✅ 编写底层库（liblowlevel.so）    │
│    ReadRegister(addr)              │
│    WriteRegister(addr, value)      │
│                                     │
│ ✅ 提供文档                         │
│    - 寄存器地址表                  │
│    - 数据格式说明                  │
│    - 测试程序                      │
└─────────────────────────────────────┘
```

### 3.2 IOC 团队负责（不需要懂 FPGA！）

```
┌─────────────────────────────────────┐
│        IOC 团队的工作               │
├─────────────────────────────────────┤
│ ✅ 定义 PV（给数据起名字）          │
│    BPM:CH0:Amp                     │
│    BPM:CH0:Phase                   │
│                                     │
│ ✅ 调用 FPGA 团队提供的库           │
│    value = ReadRegister(0x0010)    │
│                                     │
│ ✅ 数据转换                         │
│    raw_value → 物理量（伏特、度等）│
│                                     │
│ ✅ 提供用户界面                     │
│    - 命令行工具（caget/caput）     │
│    - 图形界面（CSS/EDM）           │
└─────────────────────────────────────┘
```

**重点**：
- IOC 开发者**不需要**懂 FPGA 内部如何工作
- 只需要知道"读哪个地址、写哪个地址"
- 数据格式由 FPGA 团队提供

---

## 4. 实际例子：BPM 系统

### 4.1 系统组成

```
┌──────────────────────────────────────────────────┐
│           BPM（束流位置监测器）系统              │
├──────────────────────────────────────────────────┤
│                                                  │
│  粒子束 ──►│ RF天线 │──► ADC ──► FPGA ──► IOC  │
│            （4个）        采样    处理    控制   │
│                                           │     │
│                                           ▼     │
│                                    显示X,Y位置  │
└──────────────────────────────────────────────────┘
```

### 4.2 数据流（具体）

1. **物理过程**：
   - 粒子束经过 → RF 天线感应到信号
   - ADC 采样 → 得到 4 路信号（A, B, C, D）

2. **FPGA 处理**：
   - 计算幅度和相位
   - 计算位置：X = k × (A-C)/(A+C)
   - 存储到寄存器

3. **IOC 读取**：
   ```bash
   $ caget BPM1:PosX
   BPM1:PosX    2.345 mm    # X 方向位置

   $ caget BPM1:PosY
   BPM1:PosY   -1.234 mm    # Y 方向位置
   ```

4. **用户看到**：
   - 图形界面上显示一个点 (2.345, -1.234)
   - 表示粒子束的位置

### 4.3 控制流（具体）

1. **设置参数**：
   ```bash
   $ caput BPM1:K1:Set 1.234
   # 设置位置计算系数
   ```

2. **数据转换**：
   ```
   1.234 → 0x00009EBA（定点数格式）
   ```

3. **FPGA 应用**：
   - 使用新的 K1 系数重新计算位置
   - 位置值立即更新

4. **用户验证**：
   ```bash
   $ caget BPM1:PosX
   BPM1:PosX    2.567 mm    # 位置改变了
   ```

---

## 5. 你需要学什么？

### 5.1 如果只想理解原理（推荐）

**必须理解**：
- ✅ PV 是什么（就是"有名字的变量"）
- ✅ IOC 是桥梁（连接用户和硬件）
- ✅ FPGA 通过寄存器通信（类似内存地址）
- ✅ 数据需要转换（原始值 → 物理量）

**可以跳过**：
- ❌ 具体的 C 代码怎么写
- ❌ EPICS 内部实现细节
- ❌ FPGA 逻辑设计

**学习方法**：
1. 看架构图，理解数据流
2. 使用现成的 IOC，运行 caget/caput 命令
3. 观察 PV 值的变化

### 5.2 如果将来想开发 IOC（进阶）

**学习路径**（按顺序）：

**第1阶段：C 语言基础（2-4周）**
- 变量和函数
- 指针（重点！）
- 结构体
- 推荐书籍：《C Primer Plus》前10章

**第2阶段：Linux 基础（1-2周）**
- 基本命令（cd, ls, cat, grep）
- 文件系统
- 编译（gcc, make）

**第3阶段：EPICS 基础（2-3周）**
- 安装 EPICS Base
- 运行简单的 IOC
- 定义简单的 .db 文件
- 使用 caget/caput

**第4阶段：设备支持开发（3-4周）**
- 理解 Device Support 结构
- 编写简单的 Device Support
- 调用硬件库
- 数据转换

**总计**：约 2-3 个月可以掌握基本开发能力

---

## 6. 实践建议（无需编程）

### 6.1 使用现成的系统

如果你有访问 BPMIOC 系统的权限：

```bash
# 1. 查看所有 PV
$ caget -d BPM1:*

# 2. 监控一个 PV 的变化
$ camonitor BPM1:CH0:Amp
BPM1:CH0:Amp    2024-11-18 10:00:00  0.12345
BPM1:CH0:Amp    2024-11-18 10:00:01  0.12347
BPM1:CH0:Amp    2024-11-18 10:00:02  0.12350
^C

# 3. 测试写入
$ caput BPM1:DO:Set 1    # 打开数字输出
$ caput BPM1:DO:Set 0    # 关闭数字输出
```

### 6.2 学习资源

**视频教程**：
- EPICS 官方培训视频（YouTube）
- 国内 EPICS 培训录像

**在线文档**：
- [EPICS 官方文档](https://docs.epics-controls.org/)
- [菜鸟教程 - C 语言](https://www.runoob.com/cprogramming/c-tutorial.html)

**示例项目**：
- 研究 BPMIOC 项目的 .db 文件（不看代码，只看 PV 定义）
- 理解 PV 名称和功能的对应关系

---

## 7. 常见疑问

**Q: 我不懂编程，能做 IOC 开发吗？**

A: 需要学习基础的 C 语言，但不需要很深。重点是理解：
- 如何调用函数
- 如何处理数据
- 如何使用 EPICS 提供的框架

**Q: 我需要学习 FPGA 开发吗？**

A: **不需要！** 作为 IOC 开发者，你只需要：
- 知道寄存器地址（FPGA 团队提供）
- 调用读写函数（库已经提供）
- 转换数据格式（公式 FPGA 团队提供）

**Q: 技术文档里的代码看不懂怎么办？**

A:
1. **先看架构图和流程图**，跳过代码
2. **理解概念**比理解代码更重要
3. **慢慢学习 C 语言**，从简单的开始
4. **不要急于求成**，先理解"是什么"，再学"怎么做"

---

## 8. 下一步行动

### 立即可以做的（今天）

1. ✅ 阅读本文档，理解系统架构
2. ✅ 如果有现成系统，尝试运行 `caget` 命令
3. ✅ 画出你理解的数据流图

### 本周可以做的

1. ✅ 浏览 EPICS 官方网站
2. ✅ 安装 EPICS Base（跟着教程）
3. ✅ 运行第一个简单的 IOC

### 本月可以做的

1. ✅ 学习 C 语言基础（每天1小时）
2. ✅ 阅读技术文档的第一、二、五部分
3. ✅ 参加 EPICS 在线培训（如果有）

---

## 总结

**记住这些关键点**：

1. **EPICS-FPGA 交互本质上很简单**：
   - IOC 读写 FPGA 的寄存器
   - 数据需要格式转换
   - PV 是对外的接口

2. **你不需要懂所有细节**：
   - 先理解架构
   - 再理解流程
   - 最后才是代码

3. **编程是可以学的**：
   - C 语言不难（基础部分）
   - EPICS 有很多示例
   - 社区很友好，可以提问

4. **职责是分工的**：
   - FPGA 团队负责硬件
   - IOC 团队负责软件
   - 你不需要两边都懂

**最重要的**：
- 不要被代码吓到
- 先理解概念，代码只是工具
- 一步一步来，慢慢积累

加油！🚀
