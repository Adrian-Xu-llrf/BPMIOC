# 01. 加速器物理基础

> **目标**: 理解粒子加速器基本概念和LLRF系统的作用
> **难度**: ⭐⭐
> **预计时间**: 30分钟

## 1. 什么是粒子加速器？

### 1.1 基本概念

粒子加速器是利用电磁场加速带电粒子（如电子、质子）到高能量的装置。

**类比**:
- 就像跑道让运动员加速
- 电磁场就像"推力"
- 粒子在轨道上一圈圈加速

### 1.2 为什么需要加速器？

| 应用领域 | 用途 | 例子 |
|----------|------|------|
| **基础研究** | 探索物质结构 | 大型强子对撞机 (LHC) |
| **同步辐射** | 产生高亮X射线 | 上海光源、ESRF |
| **医学** | 癌症治疗 | 质子治疗 |
| **工业** | 材料改性、消毒 | 电子束辐照 |

**BPMIOC的应用场景**: 主要用于**同步辐射光源**和**自由电子激光** (FEL)

## 2. 同步加速器结构

### 2.1 主要组成

```
        ┌───────────────────────────────────┐
        │     Synchrotron Ring (环)         │
        │                                   │
    ┌───▼───┐                         ┌────▼────┐
    │  RF   │  ←───── 电子束 ─────→   │  Dipole │
    │ Cavity│         运动           │  Magnet │
    └───┬───┘                         └────┬────┘
        │                                   │
        │         ┌──────────┐             │
        └─────────┤   BPM    ├─────────────┘
                  │(束流位置) │
                  └──────────┘
```

### 2.2 核心部件

1. **RF腔 (RF Cavity)**
   - 提供加速电场
   - 频率: 通常几百MHz (如500MHz)
   - 作用: 给粒子"推力"

2. **偏转磁铁 (Dipole Magnet)**
   - 作用: 让粒子转弯
   - 类比: 赛道的弯道

3. **聚焦磁铁 (Quadrupole Magnet)**
   - 作用: 防止束流发散
   - 类比: 车道护栏

4. **BPM (Beam Position Monitor)**
   - 作用: 测量粒子位置
   - 类比: GPS定位
   - **这就是我们IOC要控制的设备！**

## 3. 束流参数

### 3.1 关键参数

| 参数 | 符号 | 物理意义 | 典型值 |
|------|------|----------|--------|
| **束流强度** | I | 每秒通过的粒子数 | 100-500mA |
| **能量** | E | 粒子动能 | 1-8 GeV |
| **发射度** | ε | 束流"粗细" | 几nm·rad |
| **位置** | x, y | 横向偏离中心的距离 | ±几mm |

### 3.2 为什么要监测这些参数？

**例子: 同步辐射光源**

```
束流稳定 → 轨道稳定 → 光束稳定 → 实验数据质量高
    ↑
  BPM监测
```

**需求**:
- 位置稳定性: <10μm (头发丝的1/10)
- 更新率: >1kHz (实时反馈控制)

## 4. LLRF系统的作用

### 4.1 什么是LLRF？

**LLRF = Low-Level Radio Frequency**（低功率射频系统）

**作用**: 精确控制RF腔的电压和相位

### 4.2 为什么需要LLRF？

**问题**: RF腔不稳定会导致：
- 束流能量漂移
- 束流丢失
- 同步辐射不稳定

**解决**: LLRF系统通过反馈控制保持稳定

```
           ┌──────────┐
 期望值 →  │  LLRF   │ → 控制信号 → RF腔
           │ 控制器   │
           └──────────┘
                ↑
                │ 反馈
           ┌────┴─────┐
           │   BPM    │ 测量束流参数
           └──────────┘
```

### 4.3 LLRF系统架构

```
┌─────────────────────────────────────────┐
│        High-Level Control               │
│     (EPICS IOC, Operator Interface)     │
└─────────────────┬───────────────────────┘
                  ↕ (Ethernet, CA)
┌─────────────────┴───────────────────────┐
│          LLRF Controller                │
│  ┌──────────┐  ┌──────────┐            │
│  │ BPM IOC  │  │  RF IOC  │            │  ← 我们的IOC在这里！
│  └──────────┘  └──────────┘            │
└─────────────────┬───────────────────────┘
                  ↕ (ADC/DAC, PCIe)
┌─────────────────┴───────────────────────┐
│         Frontend Electronics            │
│  ┌────────┐  ┌────────┐  ┌────────┐   │
│  │  BPM   │  │ RF Cav │  │  ADC   │   │
│  └────────┘  └────────┘  └────────┘   │
└─────────────────────────────────────────┘
```

## 5. BPM在LLRF中的作用

### 5.1 测量内容

BPM测量三类信息：

1. **位置信息** (x, y)
   - 束流偏离中心的距离
   - 用于轨道反馈

2. **RF信号信息** (幅度、相位)
   - 与RF腔同频的信号
   - 用于同步检查

3. **束流强度信息**
   - 通过信号总和推算
   - 用于束流监控

### 5.2 数据流

```
BPM探头          FPGA板          IOC           上层应用
  (硬件)      (信号处理)     (EPICS)       (物理软件)

┌──────┐     ┌─────────┐    ┌──────┐     ┌──────────┐
│ RF   │──→  │ ADC采样 │─→  │ PV   │──→  │ 轨道反馈 │
│ 信号 │     │ I/Q解调 │    │ 发布 │     │ 数据分析 │
└──────┘     │ 位置计算│    └──────┘     └──────────┘
             └─────────┘
```

**BPMIOC的职责**:
- 从FPGA读取处理后的数据
- 通过EPICS PV发布
- 提供历史数据归档接口

## 6. 典型运行场景

### 6.1 场景1: 束流注入

```
时间轴:
T=0s     : 束流注入开始
T=0-10s  : 束流能量逐步提升 (ramping)
T=10s    : 达到目标能量
T=10s-∞  : 稳定运行 (topping-up)

BPM IOC工作:
- 1kHz采样束流位置
- 检测位置偏离 > 阈值 → 报警
- 记录位置历史 → 分析轨道漂移
```

### 6.2 场景2: 轨道反馈

```
反馈循环 (10ms):

1. BPM测量位置 (BPM IOC)
   └─→ PV: LLRF:BPM:RFIn_01_X = 0.05mm

2. 轨道反馈算法计算修正量
   └─→ PV: LLRF:Corrector:01_Current = 0.3A

3. 校正磁铁调整
   └─→ 束流位置回到中心

4. 下一次循环...
```

## 7. 软件开发者需要知道的

### 7.1 物理约束 → 软件需求

| 物理需求 | 软件实现 |
|----------|----------|
| 位置精度 <10μm | 数据精度: float (32位) |
| 更新率 >1kHz | 扫描周期: .001 second |
| 8个BPM同步采样 | 多线程同步、时间戳对齐 |
| 数据关联性 | x, y必须同一时刻采样 |

### 7.2 合理性检查

```python
# 物理合理性检查示例
def validate_beam_position(x, y):
    """验证束流位置是否物理合理"""

    BPM_APERTURE = 20.0  # mm, BPM孔径

    # 检查1: 位置不能超出孔径
    if abs(x) > BPM_APERTURE or abs(y) > BPM_APERTURE:
        raise ValueError(f"位置超出孔径: x={x}, y={y}")

    # 检查2: 位置不能突变 (最大移动速度)
    MAX_VELOCITY = 1.0  # mm/ms
    dt = 0.001  # 1ms采样周期
    max_move = MAX_VELOCITY * dt

    if abs(x - prev_x) > max_move:
        raise ValueError(f"位置变化过快: dx={x-prev_x}")

    return True
```

### 7.3 性能考虑

```c
// 示例：高频采样的性能优化

// ❌ 慢：每个PV单独采样
for (int i = 0; i < 8; i++) {
    pv_x[i].get();  // 8次网络往返
    pv_y[i].get();
}

// ✅ 快：批量采样
ca_get_batch(pv_list, values, 16);  // 一次网络往返
```

## 8. 小结

### 关键要点

1. **加速器 = 粒子跑道**
   - RF腔提供加速
   - 磁铁控制轨道
   - BPM监测位置

2. **LLRF = 精密控制系统**
   - 保持RF腔稳定
   - BPM提供反馈信号

3. **BPM IOC的角色**
   - 采集BPM数据
   - 发布EPICS PV
   - 支持反馈控制

4. **物理需求 → 软件设计**
   - 高精度 → float类型
   - 高速率 → 性能优化
   - 高可靠 → 错误处理

### 下一步

继续学习 [02-BPM工作原理](./02-bpm-working-principle.md) 了解BPM如何测量位置。

## 📚 延伸阅读

- [CERN Accelerator School - Introduction](https://cas.web.cern.ch/)
- [Synchrotron Radiation Sources (维基百科)](https://en.wikipedia.org/wiki/Synchrotron_light_source)
- [LLRF系统综述论文](https://accelconf.web.cern.ch/)
