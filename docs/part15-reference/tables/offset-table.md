# Offsetå‚è€ƒè¡¨

> **è¯´æ˜**: BPMIOCä½¿ç”¨offsetä½œä¸ºç»Ÿä¸€æ¥å£è®¿é—®ä¸åŒçš„ç¡¬ä»¶å¯„å­˜å™¨å’Œæ•°æ®
> **ç‰ˆæœ¬**: æ ¹æ®BPMMonitor.db v1.0æ•´ç†
> **æ›´æ–°æ—¥æœŸ**: 2025-11-08

## ğŸ“‹ Offsetç³»ç»Ÿæ¦‚è¿°

### ä»€ä¹ˆæ˜¯Offset

åœ¨BPMIOCä¸­ï¼Œoffsetæ˜¯ä¸€ä¸ªæ•´æ•°æ ‡è¯†ç¬¦ï¼Œç”¨äºæŒ‡å®šè¦è®¿é—®çš„ç¡¬ä»¶å¯„å­˜å™¨æˆ–æ•°æ®ç±»å‹ã€‚

**æ•°æ®åº“ä¸­çš„æ ¼å¼**:
```
field(INP, "@TYPE:OFFSET ch=CHANNEL")
field(OUT, "@TYPE:OFFSET ch=CHANNEL")
```

**ç¤ºä¾‹**:
```
@AMP:0 ch=3        â† TYPE=AMP, OFFSET=0, CHANNEL=3
@REG:15 ch=1       â† TYPE=REG, OFFSET=15, CHANNEL=1
@ARRAY:21          â† TYPE=ARRAY, OFFSET=21, æ— channel
```

### Offsetçš„ä½œç”¨

1. **ç»Ÿä¸€æ¥å£**: æ‰€æœ‰æ•°æ®è®¿é—®éƒ½é€šè¿‡ `ReadData(offset, channel, type)` æˆ– `SetReg(offset, channel, value)`
2. **ç¡¬ä»¶æŠ½è±¡**: ä¸Šå±‚ä¸éœ€è¦çŸ¥é“å…·ä½“çš„ç¡¬ä»¶åœ°å€
3. **çµæ´»æ˜ å°„**: å¯ä»¥è½»æ¾ä¿®æ”¹offsetåˆ°ç¡¬ä»¶å¯„å­˜å™¨çš„æ˜ å°„

## ğŸ”¢ å®Œæ•´Offsetåˆ—è¡¨

### 1. AMP ç±»å‹ï¼ˆå¹…åº¦æ•°æ®ï¼‰

| Offset | ChannelèŒƒå›´ | PVç¤ºä¾‹ | å«ä¹‰ | æ•°æ®ç±»å‹ | å•ä½ |
|--------|------------|--------|------|---------|------|
| 0 | 0-9 | $(P):RFIn_01_Amp | RFè¾“å…¥é€šé“å¹…åº¦ | float | V |

**è¯´æ˜**:
- Channel 0-7: RF3-RF10çš„8ä¸ªæœ‰æ•ˆé€šé“
- Channel 8-9: ä¿ç•™é€šé“

**åº•å±‚å®ç°**:
```c
case AMP:
    return Amp[channel];  // ä»å…¨å±€æ•°ç»„Amp[]è¯»å–
```

**ç›¸å…³PV**:
```
iLinac_007:BPM14And15:RFIn_01_Amp  (@AMP:0 ch=0)  # RF3
iLinac_007:BPM14And15:RFIn_02_Amp  (@AMP:0 ch=1)  # RF4
...
iLinac_007:BPM14And15:RFIn_08_Amp  (@AMP:0 ch=7)  # RF10
```

---

### 2. PHASE ç±»å‹ï¼ˆç›¸ä½æ•°æ®ï¼‰

| Offset | ChannelèŒƒå›´ | PVç¤ºä¾‹ | å«ä¹‰ | æ•°æ®ç±»å‹ | å•ä½ |
|--------|------------|--------|------|---------|------|
| 0 | 0-9 | $(P):RFIn_01_Phase | RFè¾“å…¥é€šé“ç›¸ä½ | float | åº¦ |

**è¯´æ˜**:
- ç›¸ä½èŒƒå›´: 0-360åº¦
- Channelæ˜ å°„åŒAMPç±»å‹

**åº•å±‚å®ç°**:
```c
case PHASE:
    return Phase[channel];  // ä»å…¨å±€æ•°ç»„Phase[]è¯»å–
```

**ç›¸å…³PV**:
```
iLinac_007:BPM14And15:RFIn_01_Phase  (@PHASE:0 ch=0)
iLinac_007:BPM14And15:RFIn_02_Phase  (@PHASE:0 ch=1)
...
```

---

### 3. REG ç±»å‹ï¼ˆå¯„å­˜å™¨è®¿é—®ï¼‰

REGç±»å‹ç”¨äºè®¿é—®å„ç§ç¡¬ä»¶å¯„å­˜å™¨å’Œé…ç½®å‚æ•°ã€‚

#### 3.1 åŸºæœ¬å¯„å­˜å™¨

| Offset | Channel | PVç¤ºä¾‹ | å«ä¹‰ | è¯»/å†™ | å•ä½ |
|--------|---------|--------|------|-------|------|
| 0 | 0-1 | $(P):AlarmThreshold_Ch{1,2} | æŠ¥è­¦é˜ˆå€¼ | R/W | V |
| 1 | 0-3 | $(P):CH{1,2,3,4}_state | é€šé“çŠ¶æ€ | R/W | - |
| 2 | - | $(P):TrigDataReady | è§¦å‘æ•°æ®å°±ç»ª | R | - |
| 3 | - | $(P):TripDataReady | è¡Œç¨‹æ•°æ®å°±ç»ª | R | - |
| 4 | - | $(P):ADCDataReady | ADCæ•°æ®å°±ç»ª | R | - |

#### 3.2 é€šé“é…ç½®å¯„å­˜å™¨

| Offset | Channel | PVç¤ºä¾‹ | å«ä¹‰ | è¯»/å†™ | è¯´æ˜ |
|--------|---------|--------|------|-------|------|
| 5 | 0-7 | $(P):RFIn_{01-08}_Range | RFè¾“å…¥èŒƒå›´ | R | é‡ç¨‹è®¾ç½® |
| 6 | 2-9 | $(P):RFIn_{03-10}_Atten | RFè¾“å…¥è¡°å‡ | R | è¡°å‡å€¼ |
| 7 | 0-3 | $(P):RFout_{1-4}_status | RFè¾“å‡ºçŠ¶æ€ | R | è¾“å‡ºçŠ¶æ€ |
| 8 | 0-3 | $(P):DC_{I,Q}{1,2}_status | DCçŠ¶æ€ | R | ç›´æµçŠ¶æ€ |
| 9 | 0-3 | $(P):DC_{I,Q}{1,2}_value | DCå€¼ | R | ç›´æµå€¼ |

#### 3.3 ADCé…ç½®å¯„å­˜å™¨

| Offset | Channel | PVç¤ºä¾‹ | å«ä¹‰ | è¯»/å†™ | è¯´æ˜ |
|--------|---------|--------|------|-------|------|
| 10 | - | $(P):ADCSampleNum | ADCé‡‡æ ·æ•° | R | é‡‡æ ·ç‚¹æ•° |
| 11 | - | $(P):ADCSampleRate | ADCé‡‡æ ·ç‡ | R | é‡‡æ ·ç‡ |
| 12 | - | $(P):TrigSampleNum | è§¦å‘é‡‡æ ·æ•° | R | è§¦å‘é‡‡æ ·ç‚¹ |
| 13 | - | $(P):TrigSampleRate | è§¦å‘é‡‡æ ·ç‡ | R | è§¦å‘é‡‡æ ·ç‡ |
| 14 | - | $(P):InteTime | ç§¯åˆ†æ—¶é—´ | R | ç§¯åˆ†æ—¶é—´ |
| 15 | - | $(P):OnePlusTime | One Plusæ—¶é—´ | R | - |
| 16 | - | $(P):OnePlusSel | One Plusé€‰æ‹© | R | - |
| 17 | - | $(P):OnePlusConf | One Plusé…ç½® | R | - |
| 18 | - | $(P):TrigConf | è§¦å‘é…ç½® | R | è§¦å‘é…ç½® |
| 19 | - | $(P):TrigDelay | è§¦å‘å»¶è¿Ÿ | R | å»¶è¿Ÿæ—¶é—´ |
| 20 | - | $(P):TripConf | Tripé…ç½® | R | Tripé…ç½® |
| 21 | - | $(P):TripLevel | Tripç”µå¹³ | R | ç”µå¹³å€¼ |
| 22 | - | $(P):MasterFreq | ä¸»é¢‘ç‡ | R | Hz |
| 23 | - | $(P):MaxPwr | æœ€å¤§åŠŸç‡ | R | W |

#### 3.4 é€šé“å¹³å‡ç”µå‹

| Offset | Channel | PVç¤ºä¾‹ | å«ä¹‰ | è¯»/å†™ | è¯´æ˜ |
|--------|---------|--------|------|-------|------|
| 24 | 0-7 | $(P):RFIn_{01-08}_AVGVoltage | RFå¹³å‡ç”µå‹ | R | å¹³å‡å€¼ |

#### 3.5 é…ç½®å¯„å­˜å™¨ï¼ˆç»­ï¼‰

| Offset | Channel | PVç¤ºä¾‹ | å«ä¹‰ | è¯»/å†™ | è¯´æ˜ |
|--------|---------|--------|------|-------|------|
| 25 | - | $(P):SWVersion | è½¯ä»¶ç‰ˆæœ¬ | R | ç‰ˆæœ¬å· |
| 26 | - | $(P):HWVersion | ç¡¬ä»¶ç‰ˆæœ¬ | R | ç‰ˆæœ¬å· |
| 27 | - | $(P):ErrorCode | é”™è¯¯ä»£ç  | R | é”™è¯¯ç  |
| 28 | - | $(P):DeviceID | è®¾å¤‡ID | R | ID |

#### 3.6 æ¸©åº¦å’Œç”µå‹ç›‘æ§

| Offset | Channel | PVç¤ºä¾‹ | å«ä¹‰ | è¯»/å†™ | å•ä½ |
|--------|---------|--------|------|-------|------|
| 29 | 0-3 | $(P):Temperature{1-4} | æ¸©åº¦ä¼ æ„Ÿå™¨ | R | Â°C |
| 30 | - | $(P):MainPowerVoltage | ä¸»ç”µæºç”µå‹ | R | V |
| 31 | 0-2 | $(P):{1.8V,3.3V,12V}PowerVoltage | ç”µæºç”µå‹ | R | V |

#### 3.7 ç³»ç»ŸçŠ¶æ€

| Offset | Channel | PVç¤ºä¾‹ | å«ä¹‰ | è¯»/å†™ | è¯´æ˜ |
|--------|---------|--------|------|-------|------|
| 32 | - | $(P):SystemStatus | ç³»ç»ŸçŠ¶æ€ | R | çŠ¶æ€ç  |
| 33 | - | $(P):FirmwareDate | å›ºä»¶æ—¥æœŸ | R | æ—¥æœŸ |

#### 3.8 ç‰¹æ®Šå¯„å­˜å™¨

| Offset | Channel | PVç¤ºä¾‹ | å«ä¹‰ | è¯»/å†™ | è¯´æ˜ |
|--------|---------|--------|------|-------|------|
| 93 | 0-1 | $(P):BPM{14,15}_beam | BPMæŸæµæ£€æµ‹ | R | æŸæµçŠ¶æ€ |

---

### 4. REG ç±»å‹å†™å¯„å­˜å™¨ï¼ˆè¾“å‡ºï¼‰

ä»¥ä¸‹offsetç”¨äºå†™æ“ä½œï¼ˆfield(OUT, ...)ï¼‰ï¼š

#### 4.1 æŠ¥è­¦å’Œé€šé“æ§åˆ¶

| Offset | Channel | PVç¤ºä¾‹ | å«ä¹‰ | åŠŸèƒ½ | èŒƒå›´ |
|--------|---------|--------|------|------|------|
| 0 | 0-1 | $(P):SetAlarmThreshold_Ch{1,2} | è®¾ç½®æŠ¥è­¦é˜ˆå€¼ | å†™é˜ˆå€¼ | 0-10V |
| 1 | - | $(P):CH1_ctrl | é€šé“1æ§åˆ¶ | ä½¿èƒ½/ç¦ç”¨ | 0/1 |
| 2 | - | $(P):CH2_ctrl | é€šé“2æ§åˆ¶ | ä½¿èƒ½/ç¦ç”¨ | 0/1 |
| 3 | - | $(P):CH3_ctrl | é€šé“3æ§åˆ¶ | ä½¿èƒ½/ç¦ç”¨ | 0/1 |
| 4 | - | $(P):CH4_ctrl | é€šé“4æ§åˆ¶ | ä½¿èƒ½/ç¦ç”¨ | 0/1 |

#### 4.2 ADCé…ç½®å†™å…¥

| Offset | Channel | PVç¤ºä¾‹ | å«ä¹‰ | åŠŸèƒ½ | è¯´æ˜ |
|--------|---------|--------|------|------|------|
| 5 | - | $(P):SetADCSampleNum | è®¾ç½®ADCé‡‡æ ·æ•° | é…ç½®é‡‡æ · | ç‚¹æ•° |
| 6 | - | $(P):SetADCSampleRate | è®¾ç½®ADCé‡‡æ ·ç‡ | é…ç½®é€Ÿç‡ | Hz |
| 7 | - | $(P):SetTrigSampleNum | è®¾ç½®è§¦å‘é‡‡æ ·æ•° | é…ç½®è§¦å‘ | ç‚¹æ•° |

#### 4.3 RFé€šé“æ§åˆ¶

| Offset | Channel | PVç¤ºä¾‹ | å«ä¹‰ | åŠŸèƒ½ | è¯´æ˜ |
|--------|---------|--------|------|------|------|
| 8 | 1-8 | $(P):RFIn_{02-09}_SetRange | è®¾ç½®RFèŒƒå›´ | è®¾ç½®é‡ç¨‹ | èŒƒå›´å€¼ |

#### 4.4 é€šé“é˜ˆå€¼è®¾ç½®

| Offset | Channel | PVç¤ºä¾‹ | å«ä¹‰ | åŠŸèƒ½ | èŒƒå›´ |
|--------|---------|--------|------|------|------|
| 10 | 0-7 | $(P):RFIn_{01-08}_SetThresh_H | RFé«˜é˜ˆå€¼ | é«˜æŠ¥è­¦ | V |
| 11 | 0-7 | $(P):RFIn_{01-08}_SetThresh_L | RFä½é˜ˆå€¼ | ä½æŠ¥è­¦ | V |
| 12 | 0-7 | $(P):RFIn_{01-08}_SetThresh_HH | RFé«˜é«˜é˜ˆå€¼ | ä¸¥é‡æŠ¥è­¦ | V |
| 13 | 0-7 | $(P):RFIn_{01-08}_SetThresh_LL | RFä½ä½é˜ˆå€¼ | ä¸¥é‡æŠ¥è­¦ | V |

#### 4.5 DCé˜ˆå€¼è®¾ç½®

| Offset | Channel | PVç¤ºä¾‹ | å«ä¹‰ | åŠŸèƒ½ | è¯´æ˜ |
|--------|---------|--------|------|-------|------|
| 14 | 0-5 | $(P):DC{I,Q}{1,2,3}_SetThresh_H | DCé«˜é˜ˆå€¼ | é«˜æŠ¥è­¦ | V |
| 15 | 0-5 | $(P):DC{I,Q}{1,2,3}_SetThresh_L | DCä½é˜ˆå€¼ | ä½æŠ¥è­¦ | V |
| 16 | 0-7 | $(P):DC{I,Q}{1,2,3,4}_SetValue | DCè®¾ç½®å€¼ | è®¾ç½®DC | V |

#### 4.6 ç³»ç»Ÿé…ç½®

| Offset | Channel | PVç¤ºä¾‹ | å«ä¹‰ | åŠŸèƒ½ | è¯´æ˜ |
|--------|---------|--------|------|------|------|
| 17 | - | $(P):SetMasterFreq | è®¾ç½®ä¸»é¢‘ç‡ | é…ç½®é¢‘ç‡ | Hz |
| 18 | 0-1 | $(P):SetOnePlusConf_{1,2} | One Plusé…ç½® | é…ç½® | - |
| 19 | - | $(P):SetTrigConf | è®¾ç½®è§¦å‘é…ç½® | é…ç½®è§¦å‘ | - |
| 20 | - | $(P):SetTrigDelay | è®¾ç½®è§¦å‘å»¶è¿Ÿ | å»¶è¿Ÿ | æ—¶é’Ÿå‘¨æœŸ |
| 21 | - | $(P):SetIntegTime | è®¾ç½®ç§¯åˆ†æ—¶é—´ | ç§¯åˆ† | Î¼s |
| 22 | - | $(P):SetTripConf | è®¾ç½®Tripé…ç½® | Trip | - |
| 23 | - | $(P):SetMaxPwr | è®¾ç½®æœ€å¤§åŠŸç‡ | åŠŸç‡é™åˆ¶ | W |
| 24 | - | $(P):SetTripLevel | è®¾ç½®Tripç”µå¹³ | ç”µå¹³ | V |
| 25 | - | $(P):TrigSoftWare | è½¯ä»¶è§¦å‘ | è§¦å‘å‘½ä»¤ | 0/1 |
| 26 | - | $(P):ResetDevice | å¤ä½è®¾å¤‡ | å¤ä½ | 0/1 |

---

### 5. ARRAY ç±»å‹ï¼ˆæ³¢å½¢æ•°æ®ï¼‰

ARRAYç±»å‹ç”¨äºè¯»å–å¤§å—æ³¢å½¢æ•°æ®ï¼ˆwaveformè®°å½•ï¼‰ã€‚

#### 5.1 è§¦å‘æ³¢å½¢ï¼ˆTrigWaveformï¼‰

| Offset | Channel | PVç¤ºä¾‹ | å«ä¹‰ | æ•°æ®ç‚¹æ•° | ç±»å‹ |
|--------|---------|--------|------|---------|------|
| 1-8 | - | $(P):RFIn_{01-08}_TrigWaveform | RFè§¦å‘æ³¢å½¢ | 10,000 | float[] |
| 11-18 | - | $(P):DC{I,Q}{1,2,3,4}_TrigWaveform | DCè§¦å‘æ³¢å½¢ | 10,000 | float[] |

**è¯´æ˜**: ARRAY offset 9, 10 è¢«æ³¨é‡Šæ‰ï¼ˆæœªä½¿ç”¨ï¼‰

#### 5.2 Tripæ³¢å½¢ï¼ˆTripWaveformï¼‰

| Offset | Channel | PVç¤ºä¾‹ | å«ä¹‰ | æ•°æ®ç‚¹æ•° | ç±»å‹ |
|--------|---------|--------|------|---------|------|
| 21-28 | - | $(P):RFIn_{01-08}_TripWaveform | RF Tripæ³¢å½¢ | 100,000 | float[] |
| 31-38 | - | $(P):DC{I,Q}{1,2,3,4}_TripWaveform | DC Tripæ³¢å½¢ | 100,000 | float[] |

**è¯´æ˜**: ARRAY offset 29, 30, 39, 40 è¢«æ³¨é‡Šæ‰ï¼ˆæœªä½¿ç”¨ï¼‰

#### 5.3 èƒŒæ™¯æ³¢å½¢ï¼ˆBkgWaveformï¼‰

| Offset | Channel | PVç¤ºä¾‹ | å«ä¹‰ | æ•°æ®ç‚¹æ•° | ç±»å‹ |
|--------|---------|--------|------|---------|------|
| 41-48 | - | $(P):RFIn_{01-08}_BkgWaveform | RFèƒŒæ™¯æ³¢å½¢ | 10,000 | float[] |

**è¯´æ˜**: ARRAY offset 49, 50 è¢«æ³¨é‡Šæ‰ï¼ˆæœªä½¿ç”¨ï¼‰

#### 5.4 ADCåŸå§‹æ•°æ®ï¼ˆADCRawDataï¼‰

| Offset | Channel | PVç¤ºä¾‹ | å«ä¹‰ | æ•°æ®ç‚¹æ•° | ç±»å‹ |
|--------|---------|--------|------|---------|------|
| 61-66 | - | $(P):ADC{I,Q}{1,2,3}_RawData | ADCåŸå§‹æ•°æ® | 100,000 | float[] |

**è¯´æ˜**: ARRAY offset 73-80 è¢«æ³¨é‡Šæ‰ï¼ˆæœªä½¿ç”¨ï¼‰

#### 5.5 ADCå¤„ç†åæ•°æ®

| Offset | Channel | PVç¤ºä¾‹ | å«ä¹‰ | æ•°æ®ç‚¹æ•° | ç±»å‹ |
|--------|---------|--------|------|---------|------|
| 81-84 | - | $(P):ADC_Ch{1-4}_Data | ADCé€šé“æ•°æ® | 100,000 | float[] |

---

## ğŸ” Offsetä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: è¯»å–RF3æŒ¯å¹…

**æ•°æ®åº“å®šä¹‰**:
```
record(ai, "$(P):RFIn_01_Amp") {
    field(INP, "@AMP:0 ch=0")
    ...
}
```

**æ•°æ®æµ**:
```
è®¾å¤‡æ”¯æŒå±‚è§£æ: type="AMP", offset=0, channel=0
    â†“
è°ƒç”¨: ReadData(0, 0, AMP_TYPE)
    â†“
é©±åŠ¨å±‚è¿”å›: Amp[0]
    â†“
PVæ›´æ–°
```

### ç¤ºä¾‹2: è®¾ç½®æŠ¥è­¦é˜ˆå€¼

**æ•°æ®åº“å®šä¹‰**:
```
record(ao, "$(P):SetAlarmThreshold_Ch1") {
    field(OUT, "@REG:0 ch=0")
    ...
}
```

**æ•°æ®æµ**:
```
ç”¨æˆ·æ‰§è¡Œ: caput iLinac_007:BPM14And15:SetAlarmThreshold_Ch1 5.5
    â†“
è®¾å¤‡æ”¯æŒå±‚è§£æ: type="REG", offset=0, channel=0
    â†“
è°ƒç”¨: SetReg(0, 0, 5.5)
    â†“
é©±åŠ¨å±‚å†™å…¥ç¡¬ä»¶
    â†“
è¿”å›æˆåŠŸ
```

### ç¤ºä¾‹3: è¯»å–è§¦å‘æ³¢å½¢

**æ•°æ®åº“å®šä¹‰**:
```
record(waveform, "$(P):RFIn_01_TrigWaveform") {
    field(INP, "@ARRAY:1")
    field(NELM, "10000")
    ...
}
```

**æ•°æ®æµ**:
```
è®¾å¤‡æ”¯æŒå±‚è§£æ: type="ARRAY", offset=1
    â†“
è°ƒç”¨: readWaveform(1, 0, 10000, data_array)
    â†“
é©±åŠ¨å±‚å¡«å……10,000ä¸ªæ•°æ®ç‚¹
    â†“
æ³¢å½¢PVæ›´æ–°
```

## ğŸ“Š Offsetåˆ†é…è§„åˆ™

### è®¾è®¡åŸåˆ™

1. **ç±»å‹åˆ†ç¦»**: ä¸åŒæ•°æ®ç±»å‹ä½¿ç”¨ä¸åŒçš„TYPE (AMP/PHASE/REG/ARRAY)
2. **è¿ç»­åˆ†é…**: åŒç±»å¯„å­˜å™¨ä½¿ç”¨è¿ç»­çš„offset
3. **ä¿ç•™ç©ºé—´**: é¢„ç•™æœªä½¿ç”¨çš„offsetä¾›å°†æ¥æ‰©å±•
4. **é€šé“å‚æ•°**: å¤šé€šé“æ•°æ®ä½¿ç”¨åŒä¸€offsetï¼Œé€šè¿‡channelå‚æ•°åŒºåˆ†

### Offsetåˆ†é…ç­–ç•¥

| TYPE | OffsetèŒƒå›´ | ç”¨é€” | å¤‡æ³¨ |
|------|-----------|------|------|
| AMP | 0 | RFå¹…åº¦ | å›ºå®šoffset=0 |
| PHASE | 0 | RFç›¸ä½ | å›ºå®šoffset=0 |
| REG | 0-33 | å¸¸è§„å¯„å­˜å™¨ | è¿ç»­åˆ†é… |
| REG | 93 | ç‰¹æ®Šå¯„å­˜å™¨ | BPMæŸæµæ£€æµ‹ |
| ARRAY | 1-8 | RFè§¦å‘æ³¢å½¢ | æ¯é€šé“ä¸€ä¸ªoffset |
| ARRAY | 11-18 | DCè§¦å‘æ³¢å½¢ | é¢„ç•™9,10 |
| ARRAY | 21-28 | RF Tripæ³¢å½¢ | å¤§æ•°æ®é‡ |
| ARRAY | 31-38 | DC Tripæ³¢å½¢ | é¢„ç•™29,30 |
| ARRAY | 41-48 | RFèƒŒæ™¯æ³¢å½¢ | é¢„ç•™49,50 |
| ARRAY | 61-66 | ADCåŸå§‹æ•°æ® | I/Qé€šé“ |
| ARRAY | 81-84 | ADCå¤„ç†æ•°æ® | 4é€šé“ |

## ğŸ› ï¸ æ·»åŠ æ–°Offsetçš„æ­¥éª¤

### 1. åœ¨æ•°æ®åº“ä¸­å®šä¹‰

```
record(ai, "$(P):NewParameter") {
    field(DTYP, "BPMmonitor")
    field(INP,  "@REG:34")  # ä½¿ç”¨æ–°çš„offset
    field(SCAN, "I/O Intr")
}
```

### 2. åœ¨é©±åŠ¨å±‚å®ç°

åœ¨ `driverWrapper.c` çš„ `ReadData()` å‡½æ•°ä¸­æ·»åŠ ï¼š

```c
float ReadData(int offset, int channel, int type)
{
    if (strcmp(type, "REG") == 0) {
        switch(offset) {
            // ... ç°æœ‰ä»£ç  ...

            case 34:  // æ–°å‚æ•°
                return my_new_parameter[channel];

            // ... åç»­ä»£ç  ...
        }
    }
}
```

### 3. å¦‚æœéœ€è¦å†™æ“ä½œ

åœ¨ `SetReg()` å‡½æ•°ä¸­æ·»åŠ ï¼š

```c
void SetReg(int offset, int channel, float val)
{
    switch(offset) {
        // ... ç°æœ‰ä»£ç  ...

        case 34:
            my_new_parameter[channel] = val;
            // å¯èƒ½éœ€è¦è°ƒç”¨ç¡¬ä»¶å‡½æ•°
            (*setParameterFunc)(channel, val);
            break;

        // ... åç»­ä»£ç  ...
    }
}
```

### 4. é‡æ–°ç¼–è¯‘

```bash
make clean && make
```

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [Part 3: 05-offset-system.md](../../part3-bpmioc-architecture/05-offset-system.md) - Offsetç³»ç»Ÿè¯¦è§£
- [Part 4: 06-readdata-implementation.md](../../part4-driver-layer/06-readdata-implementation.md) - ReadDataå®ç°
- [Part 6: 04-inp-out-links.md](../../part6-database-layer/04-inp-out-links.md) - INP/OUTé“¾æ¥è¯­æ³•
- [PVå‚è€ƒè¡¨](./pv-table.md) - å®Œæ•´PVåˆ—è¡¨

## ğŸ“ æ³¨æ„äº‹é¡¹

### å‘½åçº¦å®š

- **è¯»å¯„å­˜å™¨**: ç›´æ¥ä½¿ç”¨å‚æ•°åï¼ˆå¦‚ Temperature1ï¼‰
- **å†™å¯„å­˜å™¨**: ä½¿ç”¨ `Set` å‰ç¼€ï¼ˆå¦‚ SetADCSampleNumï¼‰
- **æ³¢å½¢æ•°æ®**: ä½¿ç”¨åç¼€è¡¨ç¤ºç±»å‹ï¼ˆå¦‚ TrigWaveform, TripWaveformï¼‰

### æ•°æ®ç±»å‹å¯¹åº”

| EPICSè®°å½•ç±»å‹ | Offsetç±»å‹ | æ•°æ®å¤§å° |
|--------------|-----------|---------|
| ai (æ¨¡æ‹Ÿè¾“å…¥) | AMP, PHASE, REG | å•ä¸ªfloat |
| ao (æ¨¡æ‹Ÿè¾“å‡º) | REG | å•ä¸ªfloat |
| waveform | ARRAY | floatæ•°ç»„ |

### æ€§èƒ½è€ƒè™‘

- **é¢‘ç¹è®¿é—®**: AMPå’ŒPHASEä½¿ç”¨offset=0ï¼Œç®€åŒ–æŸ¥æ‰¾
- **å¤§æ•°æ®ä¼ è¾“**: ARRAYç±»å‹ç”¨äºæ³¢å½¢ï¼Œé¿å…å¤šæ¬¡å°æ•°æ®ä¼ è¾“
- **å¯„å­˜å™¨ç¼“å­˜**: é©±åŠ¨å±‚å¯ç¼“å­˜å¯„å­˜å™¨å€¼ï¼Œå‡å°‘ç¡¬ä»¶è®¿é—®

---

**ğŸ“Œ æ›´æ–°è®°å½•**

| æ—¥æœŸ | ç‰ˆæœ¬ | æ›´æ”¹å†…å®¹ |
|------|------|---------|
| 2025-11-08 | 1.0 | åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæ•´offsetåˆ—è¡¨ |

**ğŸ’¡ æç¤º**: å»ºè®®é…åˆ `BPMMonitor.db` å’Œ `driverWrapper.c` æºç ä¸€èµ·æŸ¥çœ‹ï¼Œä»¥ç†è§£offsetçš„å®Œæ•´å®ç°ã€‚
