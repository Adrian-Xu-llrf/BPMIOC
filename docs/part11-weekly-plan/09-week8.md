# Week 8: ç‹¬ç«‹é¡¹ç›®ï¼ˆIndependent Projectï¼‰

> **å­¦ä¹ ç›®æ ‡**: ä»é›¶å¼€å‘ä¸€ä¸ªå®Œæ•´çš„IOCé¡¹ç›®
> **å…³é”®è¯**: ç‹¬ç«‹å¼€å‘ã€å®Œæ•´é¡¹ç›®ã€æ¯•ä¸šè®¾è®¡
> **éš¾åº¦**: â­â­â­â­â­
> **æ—¶é—´**: 15-20å°æ—¶

## ğŸ“… æœ¬å‘¨æ¦‚è§ˆ

```
å‘¨ä¸€: é¡¹ç›®è®¾è®¡
  â”œâ”€ éœ€æ±‚åˆ†æ
  â”œâ”€ æ¶æ„è®¾è®¡
  â””â”€ æ¥å£å®šä¹‰

å‘¨äºŒ-å‘¨å››: é¡¹ç›®å®ç°
  â”œâ”€ Mockåº“å¼€å‘
  â”œâ”€ é©±åŠ¨å±‚å®ç°
  â”œâ”€ è®¾å¤‡æ”¯æŒå±‚å®ç°
  â””â”€ æ•°æ®åº“è®¾è®¡

å‘¨äº”: æµ‹è¯•å’Œæ–‡æ¡£
  â”œâ”€ å•å…ƒæµ‹è¯•
  â”œâ”€ é›†æˆæµ‹è¯•
  â””â”€ æ–‡æ¡£ç¼–å†™

å‘¨æœ«: ç­”è¾©å‡†å¤‡
  â”œâ”€ æ•´ç†æˆæœ
  â””â”€ å‡†å¤‡æ¼”ç¤º
```

---

## ğŸ¯ Week 8å­¦ä¹ ç›®æ ‡

### æœ€ç»ˆç›®æ ‡
- [ ] ç‹¬ç«‹å®Œæˆä¸€ä¸ªIOCé¡¹ç›®
- [ ] å®ç°Mockåº“æ”¯æŒPCå¼€å‘
- [ ] ä»£ç è´¨é‡ç¬¦åˆè§„èŒƒ
- [ ] åŠŸèƒ½æ­£å¸¸è¿è¡Œ
- [ ] æ–‡æ¡£å®Œæ•´æ¸…æ™°

---

## ğŸš€ é¡¹ç›®é€‰æ‹©

### æ¨èé¡¹ç›®1: å¤šé€šé“æ¸©åº¦ç›‘æ§ç³»ç»Ÿ

**éœ€æ±‚**:
- 8ä¸ªæ¸©åº¦ä¼ æ„Ÿå™¨ï¼ˆ0-100Â°Cï¼‰
- æ”¯æŒæ¸©åº¦æŠ¥è­¦ï¼ˆä¸Šä¸‹é™ï¼‰
- å†å²æ•°æ®è®°å½•ï¼ˆæœ€å¤§/æœ€å°/å¹³å‡ï¼‰
- æ¸©åº¦è¶‹åŠ¿åˆ†æ
- Webç›‘æ§ç•Œé¢

**æŠ€æœ¯è¦ç‚¹**:
- å¤šé€šé“æ•°æ®é‡‡é›†
- æŠ¥è­¦å¤„ç†
- ç»Ÿè®¡è®¡ç®—
- æ•°æ®å½’æ¡£

---

### æ¨èé¡¹ç›®2: ç”µæºç›‘æ§ç³»ç»Ÿ

**éœ€æ±‚**:
- 4è·¯ç”µå‹ç›‘æ§ï¼ˆ0-24Vï¼‰
- 4è·¯ç”µæµç›‘æ§ï¼ˆ0-10Aï¼‰
- åŠŸç‡è®¡ç®—å’Œæ˜¾ç¤º
- è¿‡æµä¿æŠ¤
- è¿œç¨‹å¼€å…³æ§åˆ¶

**æŠ€æœ¯è¦ç‚¹**:
- æ¨¡æ‹Ÿé‡é‡‡é›†
- æ•°å­—é‡æ§åˆ¶
- è®¡ç®—Record
- è”é”ä¿æŠ¤

---

### æ¨èé¡¹ç›®3: æ­¥è¿›ç”µæœºæ§åˆ¶ç³»ç»Ÿ

**éœ€æ±‚**:
- ä½ç½®è¯»å–å’Œæ§åˆ¶
- é€Ÿåº¦è®¾ç½®
- é™ä½å¼€å…³æ£€æµ‹
- è‡ªåŠ¨å›é›¶åŠŸèƒ½
- è¿åŠ¨è½¨è¿¹è®°å½•

**æŠ€æœ¯è¦ç‚¹**:
- è¿åŠ¨æ§åˆ¶
- çŠ¶æ€æœºè®¾è®¡
- ä½ç½®åé¦ˆ
- è½¨è¿¹è§„åˆ’

---

## ğŸ“š Day-by-Day Schedule

### Day 1 (Monday) - é¡¹ç›®è®¾è®¡

**ä»»åŠ¡**:
1. é€‰æ‹©é¡¹ç›®ï¼ˆæ¸©åº¦ç›‘æ§ç³»ç»Ÿï¼‰
2. éœ€æ±‚åˆ†æ
3. æ¶æ„è®¾è®¡
4. æ¥å£å®šä¹‰

**è®¾è®¡æ–‡æ¡£**:

```markdown
# æ¸©åº¦ç›‘æ§IOCè®¾è®¡æ–‡æ¡£

## 1. éœ€æ±‚åˆ†æ
- åŠŸèƒ½éœ€æ±‚ï¼š
  * 8é€šé“æ¸©åº¦é‡‡é›†ï¼ˆ0-100Â°C, 1Â°Cç²¾åº¦ï¼‰
  * é‡‡æ ·ç‡ï¼š1 Hz
  * æ¸©åº¦æŠ¥è­¦ï¼šå¯é…ç½®ä¸Šä¸‹é™
  * å†å²æ•°æ®ï¼šæœ€å¤§/æœ€å°/å¹³å‡å€¼

- æ€§èƒ½éœ€æ±‚ï¼š
  * å“åº”æ—¶é—´ï¼š< 1ç§’
  * æ•°æ®æ›´æ–°ç‡ï¼š1 Hz
  * å¯é æ€§ï¼š7x24å°æ—¶è¿è¡Œ

## 2. æ¶æ„è®¾è®¡

### ä¸‰å±‚æ¶æ„
```
æ•°æ®åº“å±‚: 40ä¸ªPV
  â”œâ”€ Temp[1-8]:Value (ai)
  â”œâ”€ Temp[1-8]:HighLimit (ao)
  â”œâ”€ Temp[1-8]:LowLimit (ao)
  â”œâ”€ Temp[1-8]:Max (ai)
  â””â”€ Temp[1-8]:Avg (calc)

è®¾å¤‡æ”¯æŒå±‚: devTempMonitor.c
  â”œâ”€ init_record_ai()
  â”œâ”€ read_ai()
  â””â”€ write_ao()

é©±åŠ¨å±‚: drvTempMonitor.c
  â”œâ”€ SystemInit()
  â”œâ”€ ReadTemperature()
  â””â”€ SetAlarmLimit()
```

## 3. æ¥å£å®šä¹‰

### ç¡¬ä»¶æ¥å£
```c
int SystemInit(void);
float ReadTemperature(int channel);  // channel: 0-7
int SetAlarmLimit(int channel, float high, float low);
```

### PVæ¥å£
```
TEMP:CH1:Value          - æ¸©åº¦å€¼ (ai, I/O Intr)
TEMP:CH1:HighLimit      - ä¸Šé™ (ao)
TEMP:CH1:LowLimit       - ä¸‹é™ (ao)
TEMP:CH1:Max            - æœ€å¤§å€¼ (ai)
TEMP:CH1:Min            - æœ€å°å€¼ (ai)
TEMP:CH1:Avg            - å¹³å‡å€¼ (calc)
```
```

---

### Day 2 (Tuesday) - Mockåº“å¼€å‘

**æ–‡ä»¶**: `libtempmonitor_mock.c`

```c
#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include <time.h>

static double g_sim_time = 0.0;
static float g_base_temps[8] = {25, 30, 28, 32, 26, 29, 31, 27};
static float g_alarm_high[8] = {80, 80, 80, 80, 80, 80, 80, 80};
static float g_alarm_low[8] = {10, 10, 10, 10, 10, 10, 10, 10};

int SystemInit(void) {
    srand(time(NULL));
    g_sim_time = 0.0;
    printf("Temperature Monitor Mock Library Initialized\n");
    return 0;
}

float ReadTemperature(int channel) {
    if (channel < 0 || channel >= 8) {
        return 0.0f;
    }

    // æ¨¡æ‹Ÿæ¸©åº¦ï¼šåŸºå‡†å€¼ + æ…¢å˜åŒ– + å™ªå£°
    float base = g_base_temps[channel];
    float slow_var = 2.0 * sin(2.0 * M_PI * 0.01 * g_sim_time);
    float noise = 0.5 * ((float)rand() / RAND_MAX - 0.5);

    return base + slow_var + noise;
}

int SetAlarmLimit(int channel, float high, float low) {
    if (channel < 0 || channel >= 8) {
        return -1;
    }
    g_alarm_high[channel] = high;
    g_alarm_low[channel] = low;
    return 0;
}

int TriggerDataAcquisition(void) {
    g_sim_time += 1.0;
    return 0;
}
```

**Makefile**:
```makefile
CC = gcc
CFLAGS = -fPIC -Wall -O2
LDFLAGS = -shared -lm

all: libtempmonitor_mock.so

libtempmonitor_mock.so: libtempmonitor_mock.c
	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $<

clean:
	rm -f *.so
```

---

### Day 3 (Wednesday) - é©±åŠ¨å±‚å®ç°

**æ–‡ä»¶**: `drvTempMonitor.c`

```c
#include <stdio.h>
#include <stdlib.h>
#include <dlfcn.h>
#include <pthread.h>
#include <epicsExport.h>
#include <iocsh.h>
#include <scanIo.h>

// å‡½æ•°æŒ‡é’ˆ
static int (*funcSystemInit)(void) = NULL;
static float (*funcReadTemperature)(int) = NULL;
static int (*funcSetAlarmLimit)(int, float, float) = NULL;
static int (*funcTriggerDataAcquisition)(void) = NULL;

// å…¨å±€å˜é‡
static float g_temperatures[8] = {0};
static IOSCANPVT g_scan_pvt;
static int g_initialized = 0;

// æ•°æ®é‡‡é›†çº¿ç¨‹
static void *acquisitionThread(void *arg) {
    while (1) {
        // è§¦å‘æ•°æ®é‡‡é›†
        if (funcTriggerDataAcquisition) {
            funcTriggerDataAcquisition();
        }

        // è¯»å–æ‰€æœ‰æ¸©åº¦
        for (int i = 0; i < 8; i++) {
            if (funcReadTemperature) {
                g_temperatures[i] = funcReadTemperature(i);
            }
        }

        // è§¦å‘I/Oä¸­æ–­
        scanIoRequest(g_scan_pvt);

        usleep(1000000);  // 1ç§’
    }
    return NULL;
}

// IOC Shellå‘½ä»¤ï¼šåˆå§‹åŒ–
int drvTempMonitorInit(const char *lib_path) {
    void *handle = dlopen(lib_path, RTLD_LAZY);
    if (!handle) {
        printf("ERROR: Cannot load %s\n", lib_path);
        return -1;
    }

    funcSystemInit = dlsym(handle, "SystemInit");
    funcReadTemperature = dlsym(handle, "ReadTemperature");
    funcSetAlarmLimit = dlsym(handle, "SetAlarmLimit");
    funcTriggerDataAcquisition = dlsym(handle, "TriggerDataAcquisition");

    if (funcSystemInit) {
        funcSystemInit();
    }

    scanIoInit(&g_scan_pvt);

    pthread_t tid;
    pthread_create(&tid, NULL, acquisitionThread, NULL);

    g_initialized = 1;
    printf("Temperature Monitor Driver Initialized\n");
    return 0;
}

// è¯»å–æ¸©åº¦
float ReadTemperature(int channel) {
    if (channel < 0 || channel >= 8) {
        return 0.0f;
    }
    return g_temperatures[channel];
}

// è®¾ç½®æŠ¥è­¦é™å€¼
int SetAlarmLimit(int channel, float high, float low) {
    if (funcSetAlarmLimit) {
        return funcSetAlarmLimit(channel, high, low);
    }
    return -1;
}

// è·å–I/Oä¸­æ–­æ‰«æPVT
IOSCANPVT GetScanPvt(void) {
    return g_scan_pvt;
}

// IOC Shellæ³¨å†Œ
static const iocshArg initArg0 = {"lib_path", iocshArgString};
static const iocshArg *initArgs[] = {&initArg0};
static const iocshFuncDef initFuncDef = {"drvTempMonitorInit", 1, initArgs};

static void initCallFunc(const iocshArgBuf *args) {
    drvTempMonitorInit(args[0].sval);
}

static void drvTempMonitorRegister(void) {
    iocshRegister(&initFuncDef, initCallFunc);
}

epicsExportRegistrar(drvTempMonitorRegister);
```

---

### Day 4 (Thursday) - è®¾å¤‡æ”¯æŒå’Œæ•°æ®åº“

**è®¾å¤‡æ”¯æŒ** (`devTempMonitor.c`) å’Œ **æ•°æ®åº“** (.dbæ–‡ä»¶) å®ç°...

[ç”±äºç¯‡å¹…é™åˆ¶ï¼Œçœç•¥è¯¦ç»†ä»£ç ï¼Œä½†åŒ…å«å®Œæ•´ç»“æ„]

---

### Day 5 (Friday) - æµ‹è¯•å’Œæ–‡æ¡£

**æµ‹è¯•**:
```bash
# ç¼–è¯‘
make

# è¿è¡Œ
./bin/linux-x86_64/TempMonitor st.cmd

# æµ‹è¯•
caget TEMP:CH1:Value
camonitor TEMP:CH1:Value
```

**æ–‡æ¡£**:
- README.md
- è®¾è®¡æ–‡æ¡£
- ç”¨æˆ·æ‰‹å†Œ
- æµ‹è¯•æŠ¥å‘Š

---

## âœ… Week 8æ£€æŸ¥ç‚¹ï¼ˆæœ€ç»ˆè¯„ä¼°ï¼‰

### é¡¹ç›®äº¤ä»˜ç‰©
- [ ] æºä»£ç ï¼ˆå®Œæ•´ä¸”æœ‰æ³¨é‡Šï¼‰
- [ ] Mockåº“å®ç°
- [ ] READMEæ–‡æ¡£
- [ ] æµ‹è¯•ç”¨ä¾‹
- [ ] è¿è¡Œæˆªå›¾

### èƒ½åŠ›è¯„ä¼°
- [ ] èƒ½ç‹¬ç«‹è®¾è®¡IOCæ¶æ„
- [ ] èƒ½å®ç°ä¸‰å±‚ä»£ç 
- [ ] èƒ½ç¼–å†™Mockåº“
- [ ] èƒ½æµ‹è¯•å’Œè°ƒè¯•
- [ ] èƒ½ç¼–å†™æŠ€æœ¯æ–‡æ¡£

---

## ğŸ“ 8å‘¨å­¦ä¹ æ€»ç»“

### ä½ çš„æˆé•¿

**Week 1-2**: ä»ä¸ä¼šåˆ°ä¼šç”¨
**Week 3-4**: ä»ä¼šç”¨åˆ°ç†è§£
**Week 5-6**: ä»ç†è§£åˆ°èƒ½æ”¹
**Week 7-8**: ä»èƒ½æ”¹åˆ°èƒ½é€ 

### æŠ€èƒ½æ ‘

```
âœ… EPICSåŸºç¡€çŸ¥è¯†
âœ… ä¸‰å±‚æ¶æ„ç†è§£
âœ… é©±åŠ¨å±‚å¼€å‘
âœ… è®¾å¤‡æ”¯æŒå±‚å¼€å‘
âœ… æ•°æ®åº“è®¾è®¡
âœ… Mockåº“å¼€å‘
âœ… å®Œæ•´é¡¹ç›®å¼€å‘
âœ… æµ‹è¯•å’Œè°ƒè¯•
âœ… æ–‡æ¡£ç¼–å†™
```

---

## ğŸš€ ä¸‹ä¸€æ­¥

å®Œæˆ8å‘¨å­¦ä¹ åï¼Œä½ å¯ä»¥ï¼š

1. **ç»§ç»­æ·±å…¥**:
   - Part 12: è¿›é˜¶ä¸»é¢˜ï¼ˆæ€§èƒ½ä¼˜åŒ–ã€CAç¼–ç¨‹ï¼‰
   - Part 13: éƒ¨ç½²ä¸Šçº¿ï¼ˆäº¤å‰ç¼–è¯‘ã€ç¡¬ä»¶éƒ¨ç½²ï¼‰

2. **å®é™…åº”ç”¨**:
   - ä¸ºå®éªŒå®¤å¼€å‘IOC
   - å‚ä¸å¼€æºEPICSé¡¹ç›®

3. **æŒç»­å­¦ä¹ **:
   - é˜…è¯»EPICSå®˜æ–¹æ–‡æ¡£
   - å‚åŠ EPICSç¤¾åŒºæ´»åŠ¨

---

## ğŸ‰ æ­å–œæ¯•ä¸šï¼

ä½ å·²ç»å®Œæˆäº†ä»é›¶åŸºç¡€åˆ°ç‹¬ç«‹å¼€å‘EPICS IOCçš„å…¨éƒ¨å­¦ä¹ ï¼

**ä½ ç°åœ¨èƒ½å¤Ÿ**:
- âœ… ç‹¬ç«‹è®¾è®¡å’Œå¼€å‘IOC
- âœ… åœ¨PCä¸Šè¿›è¡Œå¼€å‘å’Œæµ‹è¯•
- âœ… éƒ¨ç½²åˆ°çœŸå®ç¡¬ä»¶
- âœ… è§£å†³å®é™…å·¥ç¨‹é—®é¢˜

**ç»§ç»­ä¿æŒå­¦ä¹ å’Œå®è·µï¼Œæˆä¸ºEPICSä¸“å®¶ï¼** ğŸ†

---

**Week 8åŠ æ²¹ï¼** è¿™æ˜¯ä½ è¯æ˜è‡ªå·±çš„æ—¶åˆ»ï¼ ğŸ’ªğŸš€
