###############新增：波形平均电压计算相关PV###############

# 本底波形范围设置
record(ao, "$(P):SetBaselineStartPosition")
{
    field(DTYP, "BPMmonitor")
    field(OUT,  "@REG:27")
    field(PINI, "YES")
    field(VAL, "1600")
    field(DESC, "Baseline start point")
    field(EGU, "point")
}

record(ao, "$(P):SetBaselineStopPosition")
{
    field(DTYP, "BPMmonitor")
    field(OUT,  "@REG:28")
    field(PINI, "YES")
    field(VAL, "1650")
    field(DESC, "Baseline stop point")
    field(EGU, "point")
}



# BPM1 的 RF3-6 平均电压（有效信号 - 本底）
# 修改：使用定时扫描 instead of I/O Intr
record(ai, "$(P1):Va1p_volt_avg")
{
    field(SCAN, ".5 second")
    field(DTYP, "BPMmonitor")
    field(INP,  "@REG:34 ch=0")
    field(EGU, "V")
    field(PREC, "6")
    field(DESC, "RF3 avg voltage (signal-baseline)")
}

record(ai, "$(P1):Vb1p_volt_avg")
{
    field(SCAN, ".5 second")
    field(DTYP, "BPMmonitor")
    field(INP,  "@REG:34 ch=1")
    field(EGU, "V")
    field(PREC, "6")
    field(DESC, "RF4 avg voltage")
}

record(ai, "$(P1):Vc1p_volt_avg")
{
    field(SCAN, ".5 second")
    field(DTYP, "BPMmonitor")
    field(INP,  "@REG:34 ch=2")
    field(EGU, "V")
    field(PREC, "6")
    field(DESC, "RF5 avg voltage")
}

record(ai, "$(P1):Vd1p_volt_avg")
{
    field(SCAN, ".5 second")
    field(DTYP, "BPMmonitor")
    field(INP,  "@REG:34 ch=3")
    field(EGU, "V")
    field(PREC, "6")
    field(DESC, "RF6 avg voltage")
}

# BPM2 的 RF7-10 平均电压
record(ai, "$(P2):Va2p_volt_avg")
{
    field(SCAN, ".5 second")
    field(DTYP, "BPMmonitor")
    field(INP,  "@REG:34 ch=4")
    field(EGU, "V")
    field(PREC, "6")
    field(DESC, "RF7 avg voltage")
}

record(ai, "$(P2):Vb2p_volt_avg")
{
    field(SCAN, ".5 second")
    field(DTYP, "BPMmonitor")
    field(INP,  "@REG:34 ch=5")
    field(EGU, "V")
    field(PREC, "6")
    field(DESC, "RF8 avg voltage")
}

record(ai, "$(P2):Vc2p_volt_avg")
{
    field(SCAN, ".5 second")
    field(DTYP, "BPMmonitor")
    field(INP,  "@REG:34 ch=6")
    field(EGU, "V")
    field(PREC, "6")
    field(DESC, "RF9 avg voltage")
}

record(ai, "$(P2):Vd2p_volt_avg")
{
    field(SCAN, ".5 second")
    field(DTYP, "BPMmonitor")
    field(INP,  "@REG:34 ch=7")
    field(EGU, "V")
    field(PREC, "6")
    field(DESC, "RF10 avg voltage")
}

# Position calculations
record(calcout, "$(P1):X1_avg") {
  field(DESC, "BPM 1 X position from averaged waveforms")
  field(INPA, "$(P1):Va1p_volt_avg CP NMS")
  field(INPB, "$(P1):Vc1p_volt_avg CP NMS")
  field(INPC, "$(P1):SetKx1 CP NMS")
  field(INPD, "$(P1):SetX1_offset CP NMS")
  field(CALC, "(ABS(A+B)>1e-9)?(C*((A-B)/(A+B))+D):D")
  field(EGU, "mm")
  field(PREC, "4")
  field(SCAN, "Passive")
}

record(calcout, "$(P1):Y1_avg") {
  field(DESC, "BPM 1 Y position from averaged waveforms")
  field(INPA, "$(P1):Vb1p_volt_avg CP NMS")
  field(INPB, "$(P1):Vd1p_volt_avg CP NMS")
  field(INPC, "$(P1):SetKy1 CP NMS")
  field(INPD, "$(P1):SetY1_offset CP NMS")
  field(CALC, "(ABS(A+B)>1e-9)?(C*((A-B)/(A+B))+D):D")
  field(EGU, "mm")
  field(PREC, "4")
  field(SCAN, "Passive")
}

record(calcout, "$(P2):X2_avg") {
  field(DESC, "BPM 2 X position from averaged waveforms")
  field(INPA, "$(P2):Va2p_volt_avg CP NMS")
  field(INPB, "$(P2):Vc2p_volt_avg CP NMS")
  field(INPC, "$(P2):SetKx2 CP NMS")
  field(INPD, "$(P2):SetX2_offset CP NMS")
  field(CALC, "(ABS(A+B)>1e-9)?(C*((A-B)/(A+B))+D):D")
  field(EGU, "mm")
  field(PREC, "4")
  field(SCAN, "Passive")
}

record(calcout, "$(P2):Y2_avg") {
  field(DESC, "BPM 2 Y position from averaged waveforms")
  field(INPA, "$(P2):Vb2p_volt_avg CP NMS")
  field(INPB, "$(P2):Vd2p_volt_avg CP NMS")
  field(INPC, "$(P2):SetKy2 CP NMS")
  field(INPD, "$(P2):SetY2_offset CP NMS")
  field(CALC, "(ABS(A+B)>1e-9)?(C*((A-B)/(A+B))+D):D")
  field(EGU, "mm")
  field(PREC, "4")
  field(SCAN, "Passive")
}